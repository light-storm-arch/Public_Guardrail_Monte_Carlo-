<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Planning Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body{margin:0;padding:0}
    .font-display{font-family:'Crimson Pro',serif}
    input[type="number"],input[type="text"]{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px 14px;color:white;width:100%;transition:all 0.2s}
    input[type="number"]:focus,input[type="text"]:focus{outline:none;border-color:#e8b059;box-shadow:0 0 0 3px rgba(232,176,89,0.2)}
    input[type="range"]{-webkit-appearance:none;width:100%;height:8px;border-radius:4px;background:rgba(255,255,255,0.1)}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#e8b059;cursor:pointer}
    .checkbox-custom{appearance:none;width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-radius:4px;cursor:pointer}
    .checkbox-custom:checked{background:#e8b059;border-color:#e8b059}
    .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:16px}
    .card-accent{border-left:4px solid #e8b059}
    .btn-primary{background:linear-gradient(135deg,#e8b059 0%,#d4a04a 100%);color:#1a1a2e;font-weight:600;padding:14px 32px;border-radius:10px;border:none;cursor:pointer}
    .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
    .btn-secondary{background:rgba(255,255,255,0.1);color:white;font-weight:500;padding:14px 32px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);cursor:pointer}
    .result-card{background:linear-gradient(135deg,rgba(232,176,89,0.15) 0%,rgba(232,176,89,0.05) 100%);border:1px solid rgba(232,176,89,0.3)}
    .guardrail-upper{background:linear-gradient(135deg,rgba(76,175,80,0.15) 0%,rgba(76,175,80,0.05) 100%);border:1px solid rgba(76,175,80,0.3)}
    .guardrail-lower{background:linear-gradient(135deg,rgba(255,152,0,0.15) 0%,rgba(255,152,0,0.05) 100%);border:1px solid rgba(255,152,0,0.3)}
    .data-table{width:100%;border-collapse:collapse}
    .data-table th{background:rgba(232,176,89,0.2);padding:12px 10px;text-align:right;font-weight:600;font-size:12px;text-transform:uppercase;color:white}
    .data-table th:first-child{text-align:left}
    .data-table td{padding:10px;text-align:right;border-bottom:1px solid rgba(255,255,255,0.05);font-size:13px;color:white}
    .data-table td:first-child{text-align:left}
    .loading-spinner{width:24px;height:24px;border:3px solid rgba(26,26,46,0.3);border-top-color:#1a1a2e;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useCallback, useEffect } = React;

// Log-normal return generator: converts arithmetic mean/stdDev to log-normal returns
const logNormalReturn = (arithmeticMean, arithmeticStdDev) => {
  // Generate standard normal random number (Box-Muller)
  const u1 = Math.random(), u2 = Math.random();
  const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
  
  // Convert arithmetic parameters to log parameters
  const variance = arithmeticStdDev * arithmeticStdDev;
  const logMean = Math.log(1 + arithmeticMean) - 0.5 * Math.log(1 + variance / Math.pow(1 + arithmeticMean, 2));
  const logStdDev = Math.sqrt(Math.log(1 + variance / Math.pow(1 + arithmeticMean, 2)));
  
  // Generate log-normal return (bounded at -100%)
  return Math.exp(logMean + logStdDev * z) - 1;
};
const formatCurrency = (v) => v == null || isNaN(v) ? '$0' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
const formatNumberWithCommas = (v) => v == null || v === '' ? '' : v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
const inflateValue = (base, rate, years) => base * Math.pow(1 + rate, years);

// Calculate spending for a given year with spending smile logic
const calculateSpending = (baseSpending, year, currentYear, calendarYear, baseInflation, spendingMode, phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction) => {
  if (year === 0) return baseSpending;
  if (spendingMode === 'linear') return inflateValue(baseSpending, baseInflation, year);

  // Spending Smile mode: calculate year by year with phase-specific growth rates
  let spending = baseSpending;
  for (let y = 1; y <= year; y++) {
    const yearCal = currentYear + y;
    let growthRate = baseInflation;

    if (yearCal >= phase3StartYear) {
      growthRate = baseInflation - phase3Reduction;
    } else if (yearCal >= phase2StartYear) {
      growthRate = baseInflation - phase2Reduction;
    }

    spending *= (1 + growthRate);
  }
  return spending;
};

const CurrencyInput = ({ value, onChange }) => {
  const [display, setDisplay] = useState(formatNumberWithCommas(value));
  const handleChange = (e) => { const raw = e.target.value.replace(/,/g, ''); if (raw === '' || /^\d+$/.test(raw)) { setDisplay(formatNumberWithCommas(raw)); onChange(parseInt(raw, 10) || 0); } };
  useEffect(() => setDisplay(formatNumberWithCommas(value)), [value]);
  return <input type="text" value={display} onChange={handleChange} onBlur={() => setDisplay(formatNumberWithCommas(value))} />;
};

const PercentageInput = ({ value, onChange }) => {
  const [display, setDisplay] = useState(value.toString());
  const handleChange = (e) => { const v = e.target.value; if (v === '' || /^-?\d*\.?\d*$/.test(v)) { setDisplay(v); const n = parseFloat(v); if (!isNaN(n)) onChange(n); else if (v === '' || v === '-') onChange(0); } };
  useEffect(() => { const n = parseFloat(display); if (isNaN(n) || n !== value) setDisplay(value.toString()); }, [value]);
  return <input type="text" value={display} onChange={handleChange} onBlur={() => { const n = parseFloat(display); setDisplay(isNaN(n) ? value.toString() : n.toString()); }} />;
};

const PercentageInputNullable = ({ value, onChange, placeholder }) => {
  const [display, setDisplay] = useState(value !== null ? (value * 100).toString() : '');
  const handleChange = (e) => { const v = e.target.value; if (v === '' || /^-?\d*\.?\d*$/.test(v)) { setDisplay(v); if (v === '') onChange(null); else { const n = parseFloat(v); if (!isNaN(n)) onChange(n / 100); } } };
  useEffect(() => { if (value === null && display !== '') setDisplay(''); else if (value !== null) { const n = parseFloat(display), exp = value * 100; if (isNaN(n) || Math.abs(n - exp) > 0.0001) setDisplay(exp.toString()); } }, [value]);
  return <input type="text" value={display} onChange={handleChange} onBlur={() => { if (display === '') onChange(null); else { const n = parseFloat(display); setDisplay(isNaN(n) ? (value !== null ? (value * 100).toString() : '') : n.toString()); } }} placeholder={placeholder} />;
};

const runSimulation = (params, numSims) => {
  const { portfolioValue, planLength, expectedReturn, stdDev, baseSpending, baseInflation, goals, incomeSources, currentYear, spendingMode, phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction } = params;
  const results = [], allPaths = [];
  for (let sim = 0; sim < numSims; sim++) {
    let portfolio = portfolioValue; let success = true; const path = [portfolio];
    for (let year = 0; year < planLength; year++) {
      const calYear = currentYear + year;
      const yearSpending = calculateSpending(baseSpending, year, currentYear, calYear, baseInflation, spendingMode || 'linear', phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction);
      let yearGoals = 0;
      goals.forEach((g) => { 
        const start = g.startYear, end = g.continueThrough ? currentYear + planLength : g.endYear, inf = g.customInflation !== null ? g.customInflation : baseInflation;
        const type = g.goalType || 'onetime';
        if (type === 'onetime') {
          if (calYear === start) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
        } else if (type === 'annual') {
          if (calYear >= start && calYear <= end) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
        } else if (type === 'every') {
          const freq = g.frequency || 1;
          if (calYear >= start && calYear <= end && (calYear - start) % freq === 0) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
        }
      });
      let yearIncome = 0;
      incomeSources.forEach((i) => { const start = i.startYear, end = i.continueThrough ? currentYear + planLength : i.endYear, inf = i.customInflation !== null ? i.customInflation : baseInflation; if (calYear >= start && calYear <= end) yearIncome += year === 0 ? i.amount : inflateValue(i.amount, inf, year); });
      const netWithdrawal = yearSpending + yearGoals - yearIncome;
      const yearReturn = logNormalReturn(expectedReturn, stdDev), halfReturn = Math.pow(1 + yearReturn, 0.5) - 1;
      portfolio *= 1 + halfReturn; portfolio -= netWithdrawal;
      if (portfolio < 0) { portfolio = 0; success = false; path.push(0); for (let r = year + 1; r < planLength; r++) path.push(0); break; }
      portfolio *= 1 + halfReturn; portfolio = Math.max(0, portfolio); path.push(portfolio);
    }
    results.push({ success, endingValue: portfolio, path }); allPaths.push(path);
  }
  const successRate = results.filter(r => r.success).length / numSims;
  const endingValues = results.map(r => r.endingValue).sort((a, b) => a - b);
  const getPercentile = (arr, p) => arr[Math.min(Math.floor(arr.length * p), arr.length - 1)];
  const sortedResults = [...results].sort((a, b) => a.endingValue - b.endingValue);
  const percentilePaths = {};
  [0.1, 0.25, 0.5, 0.75, 0.9].forEach(p => { percentilePaths[`p${Math.round(p * 100)}`] = sortedResults[Math.min(Math.floor(sortedResults.length * p), sortedResults.length - 1)].path; });
  return { successRate, percentileEnding: { p10: getPercentile(endingValues, 0.1), p25: getPercentile(endingValues, 0.25), p50: getPercentile(endingValues, 0.5), p75: getPercentile(endingValues, 0.75), p90: getPercentile(endingValues, 0.9) }, percentilePaths };
};

const findPortfolioForSuccessRate = (params, targetRate, numSims) => {
  let low = 0, high = params.portfolioValue * 10;
  for (let i = 0; i < 30; i++) { const mid = (low + high) / 2; const r = runSimulation({ ...params, portfolioValue: mid }, Math.min(numSims, 2000)); if (Math.abs(r.successRate - targetRate) < 0.005) return mid; if (r.successRate < targetRate) low = mid; else high = mid; }
  return (low + high) / 2;
};

const findSpendingForSuccessRate = (params, pv, targetRate, numSims) => {
  let low = 0, high = params.baseSpending * 5;
  for (let i = 0; i < 30; i++) { const mid = (low + high) / 2; const r = runSimulation({ ...params, portfolioValue: pv, baseSpending: mid }, Math.min(numSims, 2000)); if (Math.abs(r.successRate - targetRate) < 0.005) return mid; if (r.successRate > targetRate) low = mid; else high = mid; }
  return (low + high) / 2;
};

const generateMedianProjection = (params) => {
  const { portfolioValue, planLength, expectedReturn, baseSpending, baseInflation, goals, incomeSources, currentYear, clientAge, spendingMode, phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction } = params;
  const projection = []; let portfolio = portfolioValue;
  for (let year = 0; year <= planLength; year++) {
    const calendarYear = currentYear + year, age = clientAge + year, startBalance = portfolio;
    const yearSpending = calculateSpending(baseSpending, year, currentYear, calendarYear, baseInflation, spendingMode || 'linear', phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction);
    let yearGoals = 0;
    goals.forEach((g) => { 
      const start = g.startYear, end = g.continueThrough ? currentYear + planLength : g.endYear, inf = g.customInflation !== null ? g.customInflation : baseInflation;
      const type = g.goalType || 'onetime';
      if (type === 'onetime') {
        if (calendarYear === start) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
      } else if (type === 'annual') {
        if (calendarYear >= start && calendarYear <= end) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
      } else if (type === 'every') {
        const freq = g.frequency || 1;
        if (calendarYear >= start && calendarYear <= end && (calendarYear - start) % freq === 0) yearGoals += year === 0 ? g.amount : inflateValue(g.amount, inf, year);
      }
    });
    let yearIncome = 0;
    incomeSources.forEach((i) => { const start = i.startYear, end = i.continueThrough ? currentYear + planLength : i.endYear, inf = i.customInflation !== null ? i.customInflation : baseInflation; if (calendarYear >= start && calendarYear <= end) yearIncome += year === 0 ? i.amount : inflateValue(i.amount, inf, year); });
    const netWithdrawal = yearSpending + yearGoals - yearIncome, returnRate = expectedReturn, halfReturn = Math.pow(1 + expectedReturn, 0.5) - 1;
    const midYear = portfolio * (1 + halfReturn), afterWithdraw = midYear - netWithdrawal;
    if (afterWithdraw < 0) { projection.push({ year, calendarYear, age, startBalance, baseSpending: yearSpending, goals: yearGoals, income: yearIncome, netWithdrawal, portfolioAfterWithdrawal: 0, returnRate, returnAmount: 0, endBalance: 0 }); portfolio = 0; continue; }
    const endBalance = afterWithdraw * (1 + halfReturn), returnAmount = endBalance - (startBalance - netWithdrawal);
    projection.push({ year, calendarYear, age, startBalance, baseSpending: yearSpending, goals: yearGoals, income: yearIncome, netWithdrawal, portfolioAfterWithdrawal: Math.max(0, afterWithdraw), returnRate, returnAmount, endBalance: Math.max(0, endBalance) });
    portfolio = Math.max(0, endBalance);
  }
  return projection;
};

const generatePDF = (inputs, results) => {
  const { currentYear, clientAge, planLength, portfolioValue, expectedReturn, stdDev, baseInflation, baseSpending, targetSuccessRate, upperGuardrail, lowerGuardrail, goals, incomeSources, numSimulations, spendingMode, phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction } = inputs;
  const { currentSuccess, upperGuardrailPortfolio, upperGuardrailSpending, lowerGuardrailPortfolio, lowerGuardrailSpending, percentileEnding, medianProjection } = results;
  
  let html = '<!DOCTYPE html><html><head><title>Financial Plan</title><style>body{font-family:Arial,sans-serif;padding:40px;color:#333;max-width:1100px;margin:0 auto}h1{color:#0f4c5c}h2{color:#0f4c5c;border-bottom:2px solid #e8b059;padding-bottom:8px;margin-top:30px}.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:20px 0}.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin:20px 0}.card{background:#f5f5f5;padding:20px;border-radius:8px;border-left:4px solid #0f4c5c}.label{font-size:12px;color:#666;text-transform:uppercase}.value{font-size:24px;font-weight:bold;color:#0f4c5c}.small-table{width:100%;border-collapse:collapse;margin:10px 0;font-size:14px}.small-table th{background:#0f4c5c;color:white;padding:8px;text-align:left}.small-table td{padding:8px;border-bottom:1px solid #ddd}.small-table tr:nth-child(even){background:#f9f9f9}table{width:100%;border-collapse:collapse;margin:20px 0}th{background:#0f4c5c;color:white;padding:10px;text-align:right}th:first-child{text-align:left}td{padding:8px;border-bottom:1px solid #ddd;text-align:right}td:first-child{text-align:left}.page-break{page-break-before:always}.assumptions-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}.assumptions-row:last-child{border-bottom:none}</style></head><body>';
  
  html += '<h1>Financial Plan Analysis</h1><p>Generated: ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</p>';
  
  // Plan Overview
  html += '<h2>Plan Overview</h2><div class="grid"><div class="card"><div class="label">Current Year</div><div class="value">' + currentYear + '</div></div><div class="card"><div class="label">Client Age</div><div class="value">' + clientAge + '</div></div><div class="card"><div class="label">Plan Length</div><div class="value">' + planLength + ' years</div></div></div>';
  
  // Financial Assumptions
  html += '<h2>Financial Assumptions</h2>';
  html += '<div class="grid-2"><div class="card"><div class="assumptions-row"><span>Starting Portfolio Value</span><strong>' + formatCurrency(portfolioValue) + '</strong></div>';
  html += '<div class="assumptions-row"><span>Base Annual Spending</span><strong>' + formatCurrency(baseSpending) + '</strong></div>';
  html += '<div class="assumptions-row"><span>Spending Mode</span><strong>' + (spendingMode === 'smile' ? 'Spending Smile' : 'Linear') + '</strong></div>';
  if (spendingMode === 'smile') {
    html += '<div class="assumptions-row"><span>Phase 2 Start Year</span><strong>' + phase2StartYear + '</strong></div>';
    html += '<div class="assumptions-row"><span>Phase 2 Reduction</span><strong>' + phase2Reduction.toFixed(1) + '%</strong></div>';
    html += '<div class="assumptions-row"><span>Phase 3 Start Year</span><strong>' + phase3StartYear + '</strong></div>';
    html += '<div class="assumptions-row"><span>Phase 3 Reduction</span><strong>' + phase3Reduction.toFixed(1) + '%</strong></div>';
  }
  html += '<div class="assumptions-row"><span>Expected Return</span><strong>' + (expectedReturn * 100).toFixed(2) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Standard Deviation</span><strong>' + (stdDev * 100).toFixed(2) + '%</strong></div></div>';
  html += '<div class="card"><div class="assumptions-row"><span>Base Inflation Rate</span><strong>' + (baseInflation * 100).toFixed(2) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Target Success Rate</span><strong>' + (targetSuccessRate * 100).toFixed(0) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Upper Guardrail</span><strong>' + (upperGuardrail * 100).toFixed(0) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Lower Guardrail</span><strong>' + (lowerGuardrail * 100).toFixed(0) + '%</strong></div>';
  html += '<div class="assumptions-row"><span>Simulations Run</span><strong>' + numSimulations.toLocaleString() + '</strong></div></div></div>';
  
  // Spending Goals
  html += '<h2>Spending Goals</h2>';
  if (goals.length === 0) {
    html += '<p>No spending goals defined.</p>';
  } else {
    html += '<table class="small-table"><tr><th>Name</th><th>Amount</th><th>Type</th><th>Start Year</th><th>End Year</th><th>Frequency</th><th>Inflation</th></tr>';
    goals.forEach(g => {
      const typeLabel = g.goalType === 'onetime' ? 'One-time' : g.goalType === 'annual' ? 'Annual' : 'Every ' + (g.frequency || 1) + ' yrs';
      const endYear = g.goalType === 'onetime' ? '-' : (g.continueThrough ? 'End of plan' : g.endYear);
      const freq = g.goalType === 'every' ? (g.frequency || 1) + ' years' : '-';
      const inf = g.customInflation !== null ? (g.customInflation * 100).toFixed(1) + '%' : 'Base (' + (baseInflation * 100).toFixed(1) + '%)';
      html += '<tr><td>' + (g.name || 'Unnamed') + '</td><td>' + formatCurrency(g.amount) + '</td><td>' + typeLabel + '</td><td>' + g.startYear + '</td><td>' + endYear + '</td><td>' + freq + '</td><td>' + inf + '</td></tr>';
    });
    html += '</table>';
  }
  
  // Income Sources
  html += '<h2>Income Sources</h2>';
  if (incomeSources.length === 0) {
    html += '<p>No income sources defined.</p>';
  } else {
    html += '<table class="small-table"><tr><th>Name</th><th>Annual Amount</th><th>Start Year</th><th>End Year</th><th>Inflation</th></tr>';
    incomeSources.forEach(i => {
      const endYear = i.continueThrough ? 'End of plan' : i.endYear;
      const inf = i.customInflation !== null ? (i.customInflation * 100).toFixed(1) + '%' : 'Base (' + (baseInflation * 100).toFixed(1) + '%)';
      html += '<tr><td>' + (i.name || 'Unnamed') + '</td><td>' + formatCurrency(i.amount) + '</td><td>' + i.startYear + '</td><td>' + endYear + '</td><td>' + inf + '</td></tr>';
    });
    html += '</table>';
  }
  
  // Results
  html += '<h2>Analysis Results</h2><div class="grid"><div class="card" style="background:linear-gradient(135deg,#0f4c5c,#1a6b7c);color:white;border-left:4px solid #e8b059"><div class="label" style="color:rgba(255,255,255,0.8)">Success Probability</div><div class="value" style="color:white">' + (currentSuccess * 100).toFixed(1) + '%</div></div><div class="card"><div class="label">Target Rate</div><div class="value">' + (targetSuccessRate * 100).toFixed(0) + '%</div></div><div class="card"><div class="label">Median Ending Value</div><div class="value">' + formatCurrency(percentileEnding.p50) + '</div></div></div>';
  
  // Ending Portfolio Percentiles
  html += '<h2>Ending Portfolio Percentiles</h2>';
  html += '<div class="grid" style="grid-template-columns:repeat(5,1fr)"><div class="card" style="text-align:center"><div class="label">10th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p10) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">25th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p25) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">50th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p50) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">75th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p75) + '</div></div>';
  html += '<div class="card" style="text-align:center"><div class="label">90th</div><div class="value" style="font-size:18px">' + formatCurrency(percentileEnding.p90) + '</div></div></div>';
  
  // Guardrails
  html += '<h2>Guardrail Analysis</h2><div class="grid-2"><div class="card" style="border-left-color:#4caf50"><div class="label">Upper Guardrail (' + (upperGuardrail * 100).toFixed(0) + '% Success)</div><div class="assumptions-row"><span>Portfolio Value</span><strong>' + formatCurrency(upperGuardrailPortfolio) + '</strong></div><div class="assumptions-row"><span>New Base Spending</span><strong>' + formatCurrency(upperGuardrailSpending) + '</strong></div><div class="assumptions-row"><span>Spending Change</span><strong style="color:#4caf50">+' + formatCurrency(upperGuardrailSpending - baseSpending) + '</strong></div></div>';
  html += '<div class="card" style="border-left-color:#ff9800"><div class="label">Lower Guardrail (' + (lowerGuardrail * 100).toFixed(0) + '% Success)</div><div class="assumptions-row"><span>Portfolio Value</span><strong>' + formatCurrency(lowerGuardrailPortfolio) + '</strong></div><div class="assumptions-row"><span>New Base Spending</span><strong>' + formatCurrency(lowerGuardrailSpending) + '</strong></div><div class="assumptions-row"><span>Spending Change</span><strong style="color:#ff9800">' + formatCurrency(lowerGuardrailSpending - baseSpending) + '</strong></div></div></div>';
  
  // Year-by-Year Projection
  html += '<div class="page-break"></div><h2>Year-by-Year Projection (Median Returns)</h2><table><tr><th>Year</th><th>Age</th><th>Start Balance</th><th>Spending</th><th>Goals</th><th>Income</th><th>Net Withdrawal</th><th>Return</th><th>End Balance</th></tr>';
  medianProjection.forEach(r => { html += '<tr><td>' + r.calendarYear + '</td><td>' + r.age + '</td><td>' + formatCurrency(r.startBalance) + '</td><td>' + formatCurrency(r.baseSpending) + '</td><td>' + formatCurrency(r.goals) + '</td><td>' + formatCurrency(r.income) + '</td><td>' + formatCurrency(r.netWithdrawal) + '</td><td>' + formatCurrency(r.returnAmount) + '</td><td>' + formatCurrency(r.endBalance) + '</td></tr>'; });
  html += '</table></body></html>';
  
  const blob = new Blob([html], { type: 'text/html' }), url = URL.createObjectURL(blob), link = document.createElement('a');
  link.href = url; link.download = 'Financial_Plan.html'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
};

function App() {
  const [currentYear, setCurrentYear] = useState(2026);
  const [clientAge, setClientAge] = useState(60);
  const [planLength, setPlanLength] = useState(30);
  const [portfolioValue, setPortfolioValue] = useState(1000000);
  const [expectedReturn, setExpectedReturn] = useState(7);
  const [stdDev, setStdDev] = useState(12);
  const [baseInflation, setBaseInflation] = useState(2.5);
  const [baseSpending, setBaseSpending] = useState(40000);
  const [targetSuccessRate, setTargetSuccessRate] = useState(80);
  const [upperGuardrail, setUpperGuardrail] = useState(90);
  const [lowerGuardrail, setLowerGuardrail] = useState(70);
  const [numSimulations, setNumSimulations] = useState(5000);
  const [goals, setGoals] = useState([]);
  const [incomeSources, setIncomeSources] = useState([]);
  const [results, setResults] = useState(null);
  const [isCalculating, setIsCalculating] = useState(false);
  const [spendingMode, setSpendingMode] = useState('linear');
  const [phase2StartYear, setPhase2StartYear] = useState(currentYear + 10);
  const [phase2Reduction, setPhase2Reduction] = useState(2);
  const [phase3StartYear, setPhase3StartYear] = useState(currentYear + 20);
  const [phase3Reduction, setPhase3Reduction] = useState(1);

  const addGoal = () => setGoals([...goals, { id: Date.now(), name: '', amount: 0, startYear: currentYear, goalType: 'onetime', frequency: '', endYear: currentYear + planLength, continueThrough: true, customInflation: null }]);
  const updateGoal = (id, field, value) => setGoals(goals.map(g => g.id === id ? { ...g, [field]: value } : g));
  const removeGoal = (id) => setGoals(goals.filter(g => g.id !== id));
  const addIncomeSource = () => setIncomeSources([...incomeSources, { id: Date.now(), name: '', amount: 0, startYear: currentYear, endYear: currentYear + planLength, continueThrough: true, customInflation: null }]);
  const updateIncomeSource = (id, field, value) => setIncomeSources(incomeSources.map(i => i.id === id ? { ...i, [field]: value } : i));
  const removeIncomeSource = (id) => setIncomeSources(incomeSources.filter(i => i.id !== id));

  const calculate = useCallback(() => {
    setIsCalculating(true);
    setTimeout(() => {
      const params = { portfolioValue, planLength, expectedReturn: expectedReturn / 100, stdDev: stdDev / 100, baseSpending, baseInflation: baseInflation / 100, goals, incomeSources, currentYear, clientAge, spendingMode, phase2StartYear, phase2Reduction: phase2Reduction / 100, phase3StartYear, phase3Reduction: phase3Reduction / 100 };
      const mainResult = runSimulation(params, numSimulations);
      const upperPortfolio = findPortfolioForSuccessRate(params, upperGuardrail / 100, numSimulations);
      const upperSpending = findSpendingForSuccessRate(params, upperPortfolio, targetSuccessRate / 100, numSimulations);
      const lowerPortfolio = findPortfolioForSuccessRate(params, lowerGuardrail / 100, numSimulations);
      const lowerSpending = findSpendingForSuccessRate(params, lowerPortfolio, targetSuccessRate / 100, numSimulations);
      const medianProjection = generateMedianProjection(params);
      const chartData = [];
      for (let y = 0; y <= planLength; y++) {
        chartData.push({ year: currentYear + y, p10: mainResult.percentilePaths.p10[y], p25: mainResult.percentilePaths.p25[y], p50: mainResult.percentilePaths.p50[y], p75: mainResult.percentilePaths.p75[y], p90: mainResult.percentilePaths.p90[y] });
      }
      setResults({ currentSuccess: mainResult.successRate, upperGuardrailPortfolio: upperPortfolio, upperGuardrailSpending: upperSpending, lowerGuardrailPortfolio: lowerPortfolio, lowerGuardrailSpending: lowerSpending, percentileEnding: mainResult.percentileEnding, medianProjection, chartData });
      setIsCalculating(false);
    }, 100);
  }, [portfolioValue, planLength, expectedReturn, stdDev, baseSpending, baseInflation, goals, incomeSources, currentYear, clientAge, numSimulations, targetSuccessRate, upperGuardrail, lowerGuardrail, spendingMode, phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction]);

  const exportPDF = () => { if (results) generatePDF({ currentYear, clientAge, planLength, portfolioValue, expectedReturn: expectedReturn / 100, stdDev: stdDev / 100, baseInflation: baseInflation / 100, baseSpending, targetSuccessRate: targetSuccessRate / 100, upperGuardrail: upperGuardrail / 100, lowerGuardrail: lowerGuardrail / 100, goals, incomeSources, numSimulations, spendingMode, phase2StartYear, phase2Reduction, phase3StartYear, phase3Reduction }, results); };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6">
      <div className="max-w-7xl mx-auto">
        <div className="text-center mb-10">
          <h1 className="font-display text-5xl font-semibold mb-3 bg-gradient-to-r from-amber-200 via-yellow-300 to-amber-200 bg-clip-text text-transparent">Financial Planning Calculator</h1>
          <p className="text-slate-400 text-lg">Monte Carlo simulation with dynamic guardrail analysis</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div className="card card-accent p-6">
            <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Basic Information</h2>
            <div className="space-y-4">
              <div><label className="block text-sm text-slate-400 mb-2">Current Year</label><input type="text" value={currentYear} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setCurrentYear(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setCurrentYear(2026); }} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Client Age</label><input type="text" value={clientAge} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setClientAge(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setClientAge(60); }} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Plan Length (years)</label><input type="text" value={planLength} onChange={e => { const v = e.target.value; if (v === '' || /^\d+$/.test(v)) setPlanLength(v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') setPlanLength(30); }} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Portfolio Value</label><CurrencyInput value={portfolioValue} onChange={setPortfolioValue} /></div>
            </div>
          </div>
          <div className="card card-accent p-6">
            <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Spending & Guardrails</h2>
            <div className="space-y-4">
              <div><label className="block text-sm text-slate-400 mb-2">Base Annual Spending</label><CurrencyInput value={baseSpending} onChange={setBaseSpending} /></div>
              <div>
                <label className="block text-sm text-slate-400 mb-2">Spending Mode</label>
                <div className="flex gap-4">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="spendingMode" checked={spendingMode === 'linear'} onChange={() => setSpendingMode('linear')} className="accent-amber-500" />
                    <span className="text-slate-300">Linear</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="spendingMode" checked={spendingMode === 'smile'} onChange={() => setSpendingMode('smile')} className="accent-amber-500" />
                    <span className="text-slate-300">Spending Smile</span>
                  </label>
                </div>
              </div>
              {spendingMode === 'smile' && (
                <div className="bg-slate-800/50 rounded-lg p-4 space-y-3 border border-slate-700/50">
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="block text-xs text-slate-400 mb-1">Phase 2 Start Year</label><input type="number" value={phase2StartYear} onChange={e => setPhase2StartYear(parseInt(e.target.value) || currentYear)} /></div>
                    <div><label className="block text-xs text-slate-400 mb-1">Phase 2 Reduction (%)</label><PercentageInput value={phase2Reduction} onChange={setPhase2Reduction} /></div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><label className="block text-xs text-slate-400 mb-1">Phase 3 Start Year</label><input type="number" value={phase3StartYear} onChange={e => setPhase3StartYear(parseInt(e.target.value) || currentYear)} /></div>
                    <div><label className="block text-xs text-slate-400 mb-1">Phase 3 Reduction (%)</label><PercentageInput value={phase3Reduction} onChange={setPhase3Reduction} /></div>
                  </div>
                </div>
              )}
              <div><label className="block text-sm text-slate-400 mb-2">Target Success Rate (%)</label><PercentageInput value={targetSuccessRate} onChange={setTargetSuccessRate} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Upper Guardrail (%)</label><PercentageInput value={upperGuardrail} onChange={setUpperGuardrail} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Lower Guardrail (%)</label><PercentageInput value={lowerGuardrail} onChange={setLowerGuardrail} /></div>
            </div>
          </div>
          <div className="card card-accent p-6">
            <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Market Assumptions</h2>
            <div className="space-y-4">
              <div><label className="block text-sm text-slate-400 mb-2">Expected Return (%)</label><PercentageInput value={expectedReturn} onChange={setExpectedReturn} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Standard Deviation (%)</label><PercentageInput value={stdDev} onChange={setStdDev} /></div>
              <div><label className="block text-sm text-slate-400 mb-2">Base Inflation (%)</label><PercentageInput value={baseInflation} onChange={setBaseInflation} /></div>
            </div>
          </div>
        </div>

        <div className="card card-accent p-6 mb-6">
          <div className="flex justify-between items-center mb-5">
            <h2 className="font-display text-xl font-semibold text-amber-200">Spending Goals</h2>
            <button onClick={addGoal} className="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 rounded-lg text-amber-200 text-sm font-medium">+ Add Goal</button>
          </div>
          {goals.length === 0 ? <p className="text-slate-500 text-center py-6">No goals added yet.</p> : goals.map(goal => (
            <div key={goal.id} className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-slate-700/50">
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-9 gap-4 items-end">
                <div className="col-span-2"><label className="block text-xs text-slate-400 mb-1">Name</label><input type="text" value={goal.name} onChange={e => updateGoal(goal.id, 'name', e.target.value)} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">Amount</label><CurrencyInput value={goal.amount} onChange={val => updateGoal(goal.id, 'amount', val)} /></div>
                <div className="col-span-2">
                  <label className="block text-xs text-slate-400 mb-2">Type</label>
                  <div className="flex gap-3 text-xs">
                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name={`goalType-${goal.id}`} checked={goal.goalType === 'onetime'} onChange={() => updateGoal(goal.id, 'goalType', 'onetime')} className="accent-amber-500" /><span className="text-slate-300">One-time</span></label>
                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name={`goalType-${goal.id}`} checked={goal.goalType === 'annual'} onChange={() => updateGoal(goal.id, 'goalType', 'annual')} className="accent-amber-500" /><span className="text-slate-300">Annual</span></label>
                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name={`goalType-${goal.id}`} checked={goal.goalType === 'every'} onChange={() => updateGoal(goal.id, 'goalType', 'every')} className="accent-amber-500" /><span className="text-slate-300">Every X yrs</span></label>
                  </div>
                </div>
                <div><label className="block text-xs text-slate-400 mb-1">Start Year</label><input type="number" value={goal.startYear} onChange={e => { const v = e.target.value; updateGoal(goal.id, 'startYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateGoal(goal.id, 'startYear', currentYear); }} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">Every X Yrs</label><input type="number" value={goal.frequency} onChange={e => { const v = e.target.value; updateGoal(goal.id, 'frequency', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateGoal(goal.id, 'frequency', 5); }} min="1" disabled={goal.goalType !== 'every'} style={{opacity: goal.goalType === 'every' ? 1 : 0.4}} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">End Year</label><input type="number" value={goal.endYear} onChange={e => { const v = e.target.value; updateGoal(goal.id, 'endYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateGoal(goal.id, 'endYear', currentYear + planLength); }} disabled={goal.continueThrough || goal.goalType === 'onetime'} style={{opacity: goal.goalType === 'onetime' ? 0.4 : 1}} /></div>
                <div className="flex items-center gap-2"><input type="checkbox" className="checkbox-custom" checked={goal.continueThrough} onChange={e => updateGoal(goal.id, 'continueThrough', e.target.checked)} disabled={goal.goalType === 'onetime'} style={{opacity: goal.goalType === 'onetime' ? 0.4 : 1}} /><span className="text-xs text-slate-400" style={{opacity: goal.goalType === 'onetime' ? 0.4 : 1}}>To end</span></div>
              </div>
              <div className="flex gap-4 mt-3 items-end justify-between">
                <div className="w-24"><label className="block text-xs text-slate-400 mb-1">Inflation %</label><PercentageInputNullable value={goal.customInflation} onChange={val => updateGoal(goal.id, 'customInflation', val)} placeholder={baseInflation.toString()} /></div>
                <button onClick={() => removeGoal(goal.id)} className="px-3 py-2 bg-red-500/20 rounded-lg text-red-300 text-sm">Remove</button>
              </div>
            </div>
          ))}
        </div>

        <div className="card card-accent p-6 mb-6">
          <div className="flex justify-between items-center mb-5">
            <h2 className="font-display text-xl font-semibold text-amber-200">Income Sources</h2>
            <button onClick={addIncomeSource} className="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 rounded-lg text-amber-200 text-sm font-medium">+ Add Income</button>
          </div>
          {incomeSources.length === 0 ? <p className="text-slate-500 text-center py-6">No income sources added yet.</p> : incomeSources.map(income => (
            <div key={income.id} className="bg-slate-800/50 rounded-xl p-4 mb-4 border border-slate-700/50">
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 items-end">
                <div className="col-span-2"><label className="block text-xs text-slate-400 mb-1">Name</label><input type="text" value={income.name} onChange={e => updateIncomeSource(income.id, 'name', e.target.value)} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">Amount</label><CurrencyInput value={income.amount} onChange={val => updateIncomeSource(income.id, 'amount', val)} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">Start Year</label><input type="number" value={income.startYear} onChange={e => { const v = e.target.value; updateIncomeSource(income.id, 'startYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateIncomeSource(income.id, 'startYear', currentYear); }} /></div>
                <div><label className="block text-xs text-slate-400 mb-1">End Year</label><input type="number" value={income.endYear} onChange={e => { const v = e.target.value; updateIncomeSource(income.id, 'endYear', v === '' ? '' : parseInt(v)); }} onBlur={e => { if (e.target.value === '') updateIncomeSource(income.id, 'endYear', currentYear + planLength); }} disabled={income.continueThrough} /></div>
                <div className="flex items-center gap-2"><input type="checkbox" className="checkbox-custom" checked={income.continueThrough} onChange={e => updateIncomeSource(income.id, 'continueThrough', e.target.checked)} /><span className="text-xs text-slate-400">To end</span></div>
                <div className="flex gap-2"><div className="flex-1"><label className="block text-xs text-slate-400 mb-1">Inflation</label><PercentageInputNullable value={income.customInflation} onChange={val => updateIncomeSource(income.id, 'customInflation', val)} placeholder={baseInflation.toString()} /></div><button onClick={() => removeIncomeSource(income.id)} className="px-3 py-2 bg-red-500/20 rounded-lg text-red-300">âœ•</button></div>
              </div>
            </div>
          ))}
        </div>

        <div className="card card-accent p-6 mb-8">
          <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Simulation Settings</h2>
          <div className="flex items-center gap-6">
            <span className="text-sm text-slate-400">Simulations:</span>
            <input type="range" min="1000" max="10000" step="500" value={numSimulations} onChange={e => setNumSimulations(parseInt(e.target.value))} className="flex-1" />
            <span className="text-amber-200 font-semibold">{numSimulations.toLocaleString()}</span>
          </div>
        </div>

        <div className="flex justify-center gap-4 mb-10">
          <button onClick={calculate} disabled={isCalculating} className="btn-primary flex items-center gap-3">
            {isCalculating ? <><div className="loading-spinner"></div>Calculating...</> : 'ðŸŽ² Calculate'}
          </button>
          {results && <button onClick={exportPDF} className="btn-secondary">ðŸ“„ Export PDF</button>}
        </div>

        {results && (
          <div className="space-y-8">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="card result-card p-6">
                <div className="text-sm text-amber-200/70 uppercase mb-2">Success Probability</div>
                <div className="text-4xl font-display font-semibold text-amber-100">{(results.currentSuccess * 100).toFixed(1)}%</div>
                <div className="text-sm text-slate-400 mt-2">Based on {numSimulations.toLocaleString()} simulations</div>
              </div>
              <div className="card guardrail-upper p-6">
                <div className="text-sm text-green-300/70 uppercase mb-2">Upper Guardrail ({upperGuardrail}%)</div>
                <div className="space-y-2">
                  <div className="flex justify-between"><span className="text-slate-300">Portfolio:</span><span className="font-semibold text-green-200">{formatCurrency(results.upperGuardrailPortfolio)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-300">New Spending:</span><span className="font-semibold text-green-200">{formatCurrency(results.upperGuardrailSpending)}</span></div>
                  <div className="flex justify-between pt-2 border-t border-green-500/20"><span className="text-slate-400 text-sm">Change:</span><span className="font-semibold text-green-300">+{formatCurrency(results.upperGuardrailSpending - baseSpending)}</span></div>
                </div>
              </div>
              <div className="card guardrail-lower p-6">
                <div className="text-sm text-orange-300/70 uppercase mb-2">Lower Guardrail ({lowerGuardrail}%)</div>
                <div className="space-y-2">
                  <div className="flex justify-between"><span className="text-slate-300">Portfolio:</span><span className="font-semibold text-orange-200">{formatCurrency(results.lowerGuardrailPortfolio)}</span></div>
                  <div className="flex justify-between"><span className="text-slate-300">New Spending:</span><span className="font-semibold text-orange-200">{formatCurrency(results.lowerGuardrailSpending)}</span></div>
                  <div className="flex justify-between pt-2 border-t border-orange-500/20"><span className="text-slate-400 text-sm">Change:</span><span className="font-semibold text-orange-300">{formatCurrency(results.lowerGuardrailSpending - baseSpending)}</span></div>
                </div>
              </div>
            </div>

            <div className="card card-accent p-6">
              <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Ending Portfolio Percentiles</h3>
              <div className="grid grid-cols-5 gap-4">
                {[{l:'10th',v:results.percentileEnding.p10,c:'text-red-300'},{l:'25th',v:results.percentileEnding.p25,c:'text-orange-300'},{l:'50th',v:results.percentileEnding.p50,c:'text-amber-300'},{l:'75th',v:results.percentileEnding.p75,c:'text-green-300'},{l:'90th',v:results.percentileEnding.p90,c:'text-emerald-300'}].map(p=>(
                  <div key={p.l} className="text-center bg-slate-800/50 rounded-xl p-4">
                    <div className="text-sm text-slate-400 mb-1">{p.l}</div>
                    <div className={`text-xl font-semibold ${p.c}`}>{formatCurrency(p.v)}</div>
                  </div>
                ))}
              </div>
            </div>

            {typeof Recharts !== 'undefined' && (
            <div className="card card-accent p-6">
              <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Portfolio Paths by Percentile</h3>
              <Recharts.ResponsiveContainer width="100%" height={350}>
                <Recharts.LineChart data={results.chartData}>
                  <Recharts.CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                  <Recharts.XAxis dataKey="year" stroke="#94a3b8" fontSize={12} />
                  <Recharts.YAxis stroke="#94a3b8" fontSize={12} tickFormatter={v => `$${(v/1000000).toFixed(1)}M`} />
                  <Recharts.Tooltip contentStyle={{background:'#1e293b',border:'1px solid #334155',borderRadius:'8px'}} formatter={v=>formatCurrency(v)} labelFormatter={l=>`Year ${l}`} />
                  <Recharts.Legend />
                  <Recharts.Line type="monotone" dataKey="p10" name="10th" stroke="#ef4444" strokeWidth={2} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p25" name="25th" stroke="#f97316" strokeWidth={2} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p50" name="50th (Median)" stroke="#22c55e" strokeWidth={3} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p75" name="75th" stroke="#3b82f6" strokeWidth={2} dot={false} />
                  <Recharts.Line type="monotone" dataKey="p90" name="90th" stroke="#8b5cf6" strokeWidth={2} dot={false} />
                </Recharts.LineChart>
              </Recharts.ResponsiveContainer>
            </div>
            )}

            <div className="card card-accent p-6">
              <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Year-by-Year Projection</h3>
              <div className="overflow-x-auto" style={{maxHeight:'500px',overflowY:'auto'}}>
                <table className="data-table">
                  <thead style={{position:'sticky',top:0}}><tr><th>Year</th><th>Age</th><th>Start</th><th>Spending</th><th>Goals</th><th>Income</th><th>Net</th><th>Mid-Year</th><th>Return %</th><th>Return $</th><th>End</th></tr></thead>
                  <tbody>{results.medianProjection.map(r=>(<tr key={r.year}><td>{r.calendarYear}</td><td>{r.age}</td><td>{formatCurrency(r.startBalance)}</td><td>{formatCurrency(r.baseSpending)}</td><td>{formatCurrency(r.goals)}</td><td style={{color:'#4ade80'}}>{formatCurrency(r.income)}</td><td style={{color:r.netWithdrawal>0?'#fb923c':'#4ade80'}}>{formatCurrency(r.netWithdrawal)}</td><td>{formatCurrency(r.portfolioAfterWithdrawal)}</td><td style={{color:'#60a5fa'}}>{(r.returnRate*100).toFixed(1)}%</td><td style={{color:'#60a5fa'}}>{formatCurrency(r.returnAmount)}</td><td>{formatCurrency(r.endBalance)}</td></tr>))}</tbody>
                </table>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
