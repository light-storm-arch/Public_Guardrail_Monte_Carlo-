<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Planning Calculator</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.10.4/umd/Recharts.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useCallback, useEffect } = React;
    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area } = Recharts;

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    // Box-Muller transform for normal distribution
    const normalRandom = (mean, stdDev) => {
      const u1 = Math.random();
      const u2 = Math.random();
      const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
      return mean + z * stdDev;
    };

    // Format currency
    const formatCurrency = (value) => {
      if (value === null || value === undefined || isNaN(value)) return '$0';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(value);
    };

    // Format percentage
    const formatPercent = (value) => {
      if (value === null || value === undefined || isNaN(value)) return '0%';
      return `${(value * 100).toFixed(1)}%`;
    };

    // Format number with commas for display
    const formatNumberWithCommas = (value) => {
      if (value === null || value === undefined || value === '') return '';
      return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };

    // Parse number removing commas
    const parseFormattedNumber = (value) => {
      if (!value) return 0;
      return parseInt(value.toString().replace(/,/g, ''), 10) || 0;
    };

    // Currency Input Component
    const CurrencyInput = ({ value, onChange, placeholder }) => {
      const [displayValue, setDisplayValue] = useState(formatNumberWithCommas(value));

      const handleChange = (e) => {
        const rawValue = e.target.value.replace(/,/g, '');
        if (rawValue === '' || /^\d+$/.test(rawValue)) {
          setDisplayValue(formatNumberWithCommas(rawValue));
          onChange(parseInt(rawValue, 10) || 0);
        }
      };

      const handleBlur = () => {
        setDisplayValue(formatNumberWithCommas(value));
      };

      useEffect(() => {
        setDisplayValue(formatNumberWithCommas(value));
      }, [value]);

      return (
        <input
          type="text"
          value={displayValue}
          onChange={handleChange}
          onBlur={handleBlur}
          placeholder={placeholder}
        />
      );
    };

    // Percentage Input Component - allows decimal inputs without jumping
    const PercentageInput = ({ value, onChange, placeholder }) => {
      const [displayValue, setDisplayValue] = useState(value.toString());

      const handleChange = (e) => {
        const inputValue = e.target.value;
        if (inputValue === '' || /^-?\d*\.?\d*$/.test(inputValue)) {
          setDisplayValue(inputValue);
          const numValue = parseFloat(inputValue);
          if (!isNaN(numValue)) {
            onChange(numValue);
          } else if (inputValue === '' || inputValue === '-') {
            onChange(0);
          }
        }
      };

      const handleBlur = () => {
        const numValue = parseFloat(displayValue);
        if (!isNaN(numValue)) {
          setDisplayValue(numValue.toString());
        } else {
          setDisplayValue(value.toString());
        }
      };

      useEffect(() => {
        const currentNum = parseFloat(displayValue);
        if (isNaN(currentNum) || currentNum !== value) {
          setDisplayValue(value.toString());
        }
      }, [value]);

      return (
        <input
          type="text"
          value={displayValue}
          onChange={handleChange}
          onBlur={handleBlur}
          placeholder={placeholder}
        />
      );
    };

    // Percentage Input for nullable fields (like custom inflation)
    const PercentageInputNullable = ({ value, onChange, placeholder }) => {
      const [displayValue, setDisplayValue] = useState(value !== null ? (value * 100).toString() : '');

      const handleChange = (e) => {
        const inputValue = e.target.value;
        if (inputValue === '' || /^-?\d*\.?\d*$/.test(inputValue)) {
          setDisplayValue(inputValue);
          if (inputValue === '') {
            onChange(null);
          } else {
            const numValue = parseFloat(inputValue);
            if (!isNaN(numValue)) {
              onChange(numValue / 100);
            }
          }
        }
      };

      const handleBlur = () => {
        if (displayValue === '') {
          onChange(null);
        } else {
          const numValue = parseFloat(displayValue);
          if (!isNaN(numValue)) {
            setDisplayValue(numValue.toString());
          } else {
            setDisplayValue(value !== null ? (value * 100).toString() : '');
          }
        }
      };

      useEffect(() => {
        const expectedDisplay = value !== null ? (value * 100).toString() : '';
        const currentNum = parseFloat(displayValue);
        const expectedNum = value !== null ? value * 100 : null;
        
        if (value === null && displayValue !== '') {
          setDisplayValue('');
        } else if (value !== null && (isNaN(currentNum) || Math.abs(currentNum - expectedNum) > 0.0001)) {
          setDisplayValue(expectedDisplay);
        }
      }, [value]);

      return (
        <input
          type="text"
          value={displayValue}
          onChange={handleChange}
          onBlur={handleBlur}
          placeholder={placeholder}
        />
      );
    };

    // Calculate inflated value
    const inflateValue = (baseValue, inflationRate, years) => {
      return baseValue * Math.pow(1 + inflationRate, years);
    };

    // ============================================
    // MONTE CARLO SIMULATION ENGINE
    // ============================================

    const runSimulation = (params, numSimulations) => {
      const {
        portfolioValue,
        planLength,
        expectedReturn,
        stdDev,
        baseSpending,
        baseInflation,
        goals,
        incomeSources,
      } = params;

      const results = [];
      const allPaths = [];

      for (let sim = 0; sim < numSimulations; sim++) {
        let portfolio = portfolioValue;
        const path = [portfolio];
        let success = true;

        for (let year = 0; year < planLength; year++) {
          const yearSpending = year === 0 ? baseSpending : inflateValue(baseSpending, baseInflation, year);

          let yearGoals = 0;
          goals.forEach((goal) => {
            const goalStart = goal.startYear;
            const goalEnd = goal.continueThrough ? planLength : goal.endYear;
            const frequency = goal.frequency || 0;
            const inflation = goal.customInflation !== null ? goal.customInflation : baseInflation;

            if (frequency === 0) {
              return;
            }

            if (year >= goalStart && year <= goalEnd) {
              if (frequency === 1) {
                if (year === goalStart) {
                  yearGoals += year === 0 ? goal.amount : inflateValue(goal.amount, inflation, year);
                }
              } else {
                if ((year - goalStart) % frequency === 0) {
                  yearGoals += year === 0 ? goal.amount : inflateValue(goal.amount, inflation, year);
                }
              }
            }
          });

          let yearIncome = 0;
          incomeSources.forEach((income) => {
            const incomeStart = income.startYear;
            const incomeEnd = income.continueThrough ? planLength : income.endYear;
            const inflation = income.customInflation !== null ? income.customInflation : baseInflation;

            if (year >= incomeStart && year <= incomeEnd) {
              yearIncome += year === 0 ? income.amount : inflateValue(income.amount, inflation, year);
            }
          });

          const netWithdrawal = yearSpending + yearGoals - yearIncome;

          const yearReturn = normalRandom(expectedReturn, stdDev);
          const halfYearReturn = Math.pow(1 + yearReturn, 0.5) - 1;

          portfolio *= 1 + halfYearReturn;
          portfolio -= netWithdrawal;

          if (portfolio < 0) {
            portfolio = 0;
            success = false;
            path.push(0);
            for (let remaining = year + 1; remaining < planLength; remaining++) {
              path.push(0);
            }
            break;
          }

          portfolio *= 1 + halfYearReturn;
          portfolio = Math.max(0, portfolio);
          path.push(portfolio);
        }

        results.push({
          success,
          endingValue: portfolio,
          path,
        });
        allPaths.push(path);
      }

      const successCount = results.filter((r) => r.success).length;
      const successRate = successCount / numSimulations;

      const endingValues = results.map((r) => r.endingValue).sort((a, b) => a - b);
      const getPercentile = (arr, p) => {
        const index = Math.floor(arr.length * p);
        return arr[Math.min(index, arr.length - 1)];
      };

      const percentiles = [0.1, 0.25, 0.33, 0.5, 0.67, 0.75, 0.9];
      const percentilePaths = {};

      const sortedResults = [...results].sort((a, b) => a.endingValue - b.endingValue);
      percentiles.forEach((p) => {
        const index = Math.floor(sortedResults.length * p);
        percentilePaths[`p${Math.round(p * 100)}`] = sortedResults[Math.min(index, sortedResults.length - 1)].path;
      });

      const yearlyPercentiles = [];
      for (let year = 0; year <= planLength; year++) {
        const yearValues = allPaths.map((path) => path[year] || 0).sort((a, b) => a - b);
        yearlyPercentiles.push({
          year,
          p10: getPercentile(yearValues, 0.1),
          p25: getPercentile(yearValues, 0.25),
          p50: getPercentile(yearValues, 0.5),
          p75: getPercentile(yearValues, 0.75),
          p90: getPercentile(yearValues, 0.9),
        });
      }

      return {
        successRate,
        endingValues,
        percentilePaths,
        yearlyPercentiles,
        percentileEnding: {
          p10: getPercentile(endingValues, 0.1),
          p25: getPercentile(endingValues, 0.25),
          p50: getPercentile(endingValues, 0.5),
          p75: getPercentile(endingValues, 0.75),
          p90: getPercentile(endingValues, 0.9),
        },
      };
    };

    const findPortfolioForSuccessRate = (params, targetRate, numSimulations) => {
      let low = 0;
      let high = params.portfolioValue * 10;
      let iterations = 0;
      const maxIterations = 30;
      const tolerance = 0.005;

      while (iterations < maxIterations) {
        const mid = (low + high) / 2;
        const testParams = { ...params, portfolioValue: mid };
        const result = runSimulation(testParams, Math.min(numSimulations, 2000));

        if (Math.abs(result.successRate - targetRate) < tolerance) {
          return mid;
        }

        if (result.successRate < targetRate) {
          low = mid;
        } else {
          high = mid;
        }

        iterations++;
      }

      return (low + high) / 2;
    };

    const findSpendingForSuccessRate = (params, portfolioValue, targetRate, numSimulations) => {
      let low = 0;
      let high = params.baseSpending * 5;
      let iterations = 0;
      const maxIterations = 30;
      const tolerance = 0.005;

      while (iterations < maxIterations) {
        const mid = (low + high) / 2;
        const testParams = { ...params, portfolioValue, baseSpending: mid };
        const result = runSimulation(testParams, Math.min(numSimulations, 2000));

        if (Math.abs(result.successRate - targetRate) < tolerance) {
          return mid;
        }

        if (result.successRate > targetRate) {
          low = mid;
        } else {
          high = mid;
        }

        iterations++;
      }

      return (low + high) / 2;
    };

    const generateMedianProjection = (params) => {
      const {
        portfolioValue,
        planLength,
        expectedReturn,
        baseSpending,
        baseInflation,
        goals,
        incomeSources,
        currentYear,
        clientAge,
      } = params;

      const projection = [];
      let portfolio = portfolioValue;

      for (let year = 0; year <= planLength; year++) {
        const calendarYear = currentYear + year;
        const age = clientAge + year;

        const startBalance = portfolio;

        const yearSpending = year === 0 ? baseSpending : inflateValue(baseSpending, baseInflation, year);

        let yearGoals = 0;
        goals.forEach((goal) => {
          const goalStart = goal.startYear;
          const goalEnd = goal.continueThrough ? planLength : goal.endYear;
          const frequency = goal.frequency || 0;
          const inflation = goal.customInflation !== null ? goal.customInflation : baseInflation;

          if (frequency === 0) {
            return;
          }

          if (year >= goalStart && year <= goalEnd) {
            if (frequency === 1) {
              if (year === goalStart) {
                yearGoals += year === 0 ? goal.amount : inflateValue(goal.amount, inflation, year);
              }
            } else {
              if ((year - goalStart) % frequency === 0) {
                yearGoals += year === 0 ? goal.amount : inflateValue(goal.amount, inflation, year);
              }
            }
          }
        });

        let yearIncome = 0;
        incomeSources.forEach((income) => {
          const incomeStart = income.startYear;
          const incomeEnd = income.continueThrough ? planLength : income.endYear;
          const inflation = income.customInflation !== null ? income.customInflation : baseInflation;

          if (year >= incomeStart && year <= incomeEnd) {
            yearIncome += year === 0 ? income.amount : inflateValue(income.amount, inflation, year);
          }
        });

        const netWithdrawal = yearSpending + yearGoals - yearIncome;

        const returnRate = expectedReturn;
        const halfYearReturn = Math.pow(1 + expectedReturn, 0.5) - 1;

        const portfolioAtMidYear = portfolio * (1 + halfYearReturn);
        const portfolioAfterWithdrawal = portfolioAtMidYear - netWithdrawal;

        if (portfolioAfterWithdrawal < 0) {
          projection.push({
            year,
            calendarYear,
            age,
            startBalance,
            baseSpending: yearSpending,
            goals: yearGoals,
            income: yearIncome,
            netWithdrawal,
            portfolioAfterWithdrawal: 0,
            returnRate,
            returnAmount: 0,
            endBalance: 0,
          });
          portfolio = 0;
          continue;
        }

        const endBalance = portfolioAfterWithdrawal * (1 + halfYearReturn);
        const returnAmount = endBalance - (startBalance - netWithdrawal);

        projection.push({
          year,
          calendarYear,
          age,
          startBalance,
          baseSpending: yearSpending,
          goals: yearGoals,
          income: yearIncome,
          netWithdrawal,
          portfolioAfterWithdrawal: Math.max(0, portfolioAfterWithdrawal),
          returnRate,
          returnAmount,
          endBalance: Math.max(0, endBalance),
        });

        portfolio = Math.max(0, endBalance);
      }

      return projection;
    };

    // ============================================
    // PDF EXPORT FUNCTION
    // ============================================

    const generatePDF = (inputs, results) => {
      const { currentYear, clientAge, planLength, portfolioValue, expectedReturn, stdDev, baseInflation, baseSpending, targetSuccessRate, upperGuardrail, lowerGuardrail, goals, incomeSources, numSimulations } = inputs;

      const { currentSuccess, upperGuardrailPortfolio, upperGuardrailSpending, lowerGuardrailPortfolio, lowerGuardrailSpending, percentileEnding, medianProjection } = results;

      let html = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Financial Plan Analysis</title>
          <style>
            @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap');
            
            * { margin: 0; padding: 0; box-sizing: border-box; }
            
            body {
              font-family: 'DM Sans', sans-serif;
              color: #1a1a2e;
              line-height: 1.6;
              padding: 40px;
              background: #fff;
            }
            
            .header {
              text-align: center;
              margin-bottom: 40px;
              padding-bottom: 20px;
              border-bottom: 3px solid #0f4c5c;
            }
            
            h1 {
              font-family: 'Crimson Pro', serif;
              font-size: 32px;
              color: #0f4c5c;
              margin-bottom: 8px;
            }
            
            .date {
              color: #666;
              font-size: 14px;
            }
            
            h2 {
              font-family: 'Crimson Pro', serif;
              font-size: 22px;
              color: #0f4c5c;
              margin: 30px 0 15px 0;
              padding-bottom: 8px;
              border-bottom: 2px solid #e8b059;
            }
            
            .section {
              margin-bottom: 30px;
            }
            
            .grid {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 20px;
              margin-bottom: 20px;
            }
            
            .card {
              background: #f8f9fa;
              border-radius: 8px;
              padding: 20px;
              border-left: 4px solid #0f4c5c;
            }
            
            .card-label {
              font-size: 12px;
              text-transform: uppercase;
              letter-spacing: 1px;
              color: #666;
              margin-bottom: 4px;
            }
            
            .card-value {
              font-size: 24px;
              font-weight: 600;
              color: #0f4c5c;
            }
            
            .result-card {
              background: linear-gradient(135deg, #0f4c5c 0%, #1a6b7c 100%);
              color: white;
              border-left: 4px solid #e8b059;
            }
            
            .result-card .card-label {
              color: rgba(255,255,255,0.8);
            }
            
            .result-card .card-value {
              color: white;
            }
            
            .guardrail-grid {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 20px;
            }
            
            .guardrail-card {
              padding: 25px;
              border-radius: 8px;
            }
            
            .upper { background: #e8f5e9; border-left: 4px solid #4caf50; }
            .lower { background: #fff3e0; border-left: 4px solid #ff9800; }
            
            .guardrail-title {
              font-weight: 600;
              font-size: 16px;
              margin-bottom: 15px;
              color: #333;
            }
            
            .guardrail-row {
              display: flex;
              justify-content: space-between;
              padding: 8px 0;
              border-bottom: 1px solid rgba(0,0,0,0.1);
            }
            
            .guardrail-row:last-child { border-bottom: none; }
            
            table {
              width: 100%;
              border-collapse: collapse;
              font-size: 11px;
              margin-top: 15px;
            }
            
            th {
              background: #0f4c5c;
              color: white;
              padding: 10px 8px;
              text-align: right;
              font-weight: 500;
            }
            
            th:first-child { text-align: left; }
            
            td {
              padding: 8px;
              text-align: right;
              border-bottom: 1px solid #e0e0e0;
            }
            
            td:first-child { text-align: left; }
            
            tr:nth-child(even) { background: #f8f9fa; }
            
            .assumptions-grid {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 10px;
            }
            
            .assumption-item {
              display: flex;
              justify-content: space-between;
              padding: 8px 12px;
              background: #f8f9fa;
              border-radius: 4px;
            }
            
            .assumption-label { color: #666; }
            .assumption-value { font-weight: 500; }
            
            .goals-list, .income-list {
              margin-top: 10px;
            }
            
            .list-item {
              background: #f8f9fa;
              padding: 12px 15px;
              border-radius: 6px;
              margin-bottom: 8px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            
            .list-item-name { font-weight: 500; }
            .list-item-details { color: #666; font-size: 13px; }
            
            .percentile-grid {
              display: grid;
              grid-template-columns: repeat(5, 1fr);
              gap: 10px;
              margin-top: 15px;
            }
            
            .percentile-item {
              text-align: center;
              padding: 15px 10px;
              background: #f8f9fa;
              border-radius: 6px;
            }
            
            .percentile-label {
              font-size: 12px;
              color: #666;
              margin-bottom: 4px;
            }
            
            .percentile-value {
              font-size: 16px;
              font-weight: 600;
              color: #0f4c5c;
            }
            
            .page-break {
              page-break-before: always;
            }
            
            @media print {
              body { padding: 20px; }
              .page-break { page-break-before: always; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Financial Plan Analysis</h1>
            <div class="date">Generated on ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
          </div>
          
          <div class="section">
            <h2>Plan Overview</h2>
            <div class="grid">
              <div class="card">
                <div class="card-label">Current Year</div>
                <div class="card-value">${currentYear}</div>
              </div>
              <div class="card">
                <div class="card-label">Client Age</div>
                <div class="card-value">${clientAge}</div>
              </div>
              <div class="card">
                <div class="card-label">Plan Length</div>
                <div class="card-value">${planLength} years</div>
              </div>
            </div>
          </div>
          
          <div class="section">
            <h2>Financial Assumptions</h2>
            <div class="assumptions-grid">
              <div class="assumption-item">
                <span class="assumption-label">Current Portfolio</span>
                <span class="assumption-value">${formatCurrency(portfolioValue)}</span>
              </div>
              <div class="assumption-item">
                <span class="assumption-label">Base Annual Spending</span>
                <span class="assumption-value">${formatCurrency(baseSpending)}</span>
              </div>
              <div class="assumption-item">
                <span class="assumption-label">Expected Return</span>
                <span class="assumption-value">${(expectedReturn * 100).toFixed(1)}%</span>
              </div>
              <div class="assumption-item">
                <span class="assumption-label">Standard Deviation</span>
                <span class="assumption-value">${(stdDev * 100).toFixed(1)}%</span>
              </div>
              <div class="assumption-item">
                <span class="assumption-label">Base Inflation</span>
                <span class="assumption-value">${(baseInflation * 100).toFixed(1)}%</span>
              </div>
              <div class="assumption-item">
                <span class="assumption-label">Simulations Run</span>
                <span class="assumption-value">${numSimulations.toLocaleString()}</span>
              </div>
            </div>
          </div>
          
          ${goals.length > 0 ? `
          <div class="section">
            <h2>Spending Goals</h2>
            <div class="goals-list">
              ${goals.map(g => `
                <div class="list-item">
                  <div>
                    <div class="list-item-name">${g.name}</div>
                    <div class="list-item-details">
                      ${g.frequency === 0 ? 'Never' : g.frequency === 1 ? 'One-time' : `Every ${g.frequency} year(s)`} â€¢ 
                      Start: Year ${g.startYear} â€¢ 
                      End: ${g.continueThrough ? 'End of plan' : `Year ${g.endYear}`} â€¢
                      Inflation: ${g.customInflation !== null ? (g.customInflation * 100).toFixed(1) : (baseInflation * 100).toFixed(1)}%
                    </div>
                  </div>
                  <div class="list-item-name">${formatCurrency(g.amount)}</div>
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}
          
          ${incomeSources.length > 0 ? `
          <div class="section">
            <h2>Income Sources</h2>
            <div class="income-list">
              ${incomeSources.map(i => `
                <div class="list-item">
                  <div>
                    <div class="list-item-name">${i.name}</div>
                    <div class="list-item-details">
                      Start: Year ${i.startYear} â€¢ 
                      End: ${i.continueThrough ? 'End of plan' : `Year ${i.endYear}`} â€¢
                      Inflation: ${i.customInflation !== null ? (i.customInflation * 100).toFixed(1) : (baseInflation * 100).toFixed(1)}%
                    </div>
                  </div>
                  <div class="list-item-name">${formatCurrency(i.amount)}/year</div>
                </div>
              `).join('')}
            </div>
          </div>
          ` : ''}
          
          <div class="page-break"></div>
          
          <div class="section">
            <h2>Analysis Results</h2>
            <div class="grid">
              <div class="card result-card">
                <div class="card-label">Current Success Probability</div>
                <div class="card-value">${(currentSuccess * 100).toFixed(1)}%</div>
              </div>
              <div class="card">
                <div class="card-label">Target Success Rate</div>
                <div class="card-value">${(targetSuccessRate * 100).toFixed(1)}%</div>
              </div>
              <div class="card">
                <div class="card-label">Median Ending Value</div>
                <div class="card-value">${formatCurrency(percentileEnding.p50)}</div>
              </div>
            </div>
          </div>
          
          <div class="section">
            <h2>Guardrail Analysis</h2>
            <div class="guardrail-grid">
              <div class="guardrail-card upper">
                <div class="guardrail-title">ðŸ“ˆ Upper Guardrail (${(upperGuardrail * 100).toFixed(0)}% Success)</div>
                <div class="guardrail-row">
                  <span>Portfolio Value</span>
                  <strong>${formatCurrency(upperGuardrailPortfolio)}</strong>
                </div>
                <div class="guardrail-row">
                  <span>New Base Spending</span>
                  <strong>${formatCurrency(upperGuardrailSpending)}</strong>
                </div>
                <div class="guardrail-row">
                  <span>Spending Change</span>
                  <strong style="color: #4caf50;">+${formatCurrency(upperGuardrailSpending - baseSpending)}</strong>
                </div>
              </div>
              <div class="guardrail-card lower">
                <div class="guardrail-title">ðŸ“‰ Lower Guardrail (${(lowerGuardrail * 100).toFixed(0)}% Success)</div>
                <div class="guardrail-row">
                  <span>Portfolio Value</span>
                  <strong>${formatCurrency(lowerGuardrailPortfolio)}</strong>
                </div>
                <div class="guardrail-row">
                  <span>New Base Spending</span>
                  <strong>${formatCurrency(lowerGuardrailSpending)}</strong>
                </div>
                <div class="guardrail-row">
                  <span>Spending Change</span>
                  <strong style="color: #ff9800;">${formatCurrency(lowerGuardrailSpending - baseSpending)}</strong>
                </div>
              </div>
            </div>
          </div>
          
          <div class="section">
            <h2>Ending Portfolio Percentiles</h2>
            <div class="percentile-grid">
              <div class="percentile-item">
                <div class="percentile-label">10th Percentile</div>
                <div class="percentile-value">${formatCurrency(percentileEnding.p10)}</div>
              </div>
              <div class="percentile-item">
                <div class="percentile-label">25th Percentile</div>
                <div class="percentile-value">${formatCurrency(percentileEnding.p25)}</div>
              </div>
              <div class="percentile-item">
                <div class="percentile-label">50th Percentile</div>
                <div class="percentile-value">${formatCurrency(percentileEnding.p50)}</div>
              </div>
              <div class="percentile-item">
                <div class="percentile-label">75th Percentile</div>
                <div class="percentile-value">${formatCurrency(percentileEnding.p75)}</div>
              </div>
              <div class="percentile-item">
                <div class="percentile-label">90th Percentile</div>
                <div class="percentile-value">${formatCurrency(percentileEnding.p90)}</div>
              </div>
            </div>
          </div>
          
          <div class="page-break"></div>
          
          <div class="section">
            <h2>Year-by-Year Projection (Median Returns, Mid-Year Withdrawal)</h2>
            <table>
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Age</th>
                  <th>Start Balance</th>
                  <th>Base Spending</th>
                  <th>Goals</th>
                  <th>Income</th>
                  <th>Net Withdrawal</th>
                  <th>Portfolio (Mid-Year)</th>
                  <th>Return %</th>
                  <th>Return $</th>
                  <th>End Balance</th>
                </tr>
              </thead>
              <tbody>
                ${medianProjection.map(row => `
                  <tr>
                    <td>${row.calendarYear}</td>
                    <td>${row.age}</td>
                    <td>${formatCurrency(row.startBalance)}</td>
                    <td>${formatCurrency(row.baseSpending)}</td>
                    <td>${formatCurrency(row.goals)}</td>
                    <td>${formatCurrency(row.income)}</td>
                    <td>${formatCurrency(row.netWithdrawal)}</td>
                    <td>${formatCurrency(row.portfolioAfterWithdrawal)}</td>
                    <td>${(row.returnRate * 100).toFixed(1)}%</td>
                    <td>${formatCurrency(row.returnAmount)}</td>
                    <td>${formatCurrency(row.endBalance)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </body>
        </html>
      `;

      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `Financial_Plan_${currentYear}_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    // ============================================
    // MAIN COMPONENT
    // ============================================

    function FinancialPlanningCalculator() {
      const [currentYear, setCurrentYear] = useState(2026);
      const [clientAge, setClientAge] = useState(60);
      const [planLength, setPlanLength] = useState(30);
      const [portfolioValue, setPortfolioValue] = useState(1000000);

      const [expectedReturn, setExpectedReturn] = useState(7);
      const [stdDev, setStdDev] = useState(12);
      const [baseInflation, setBaseInflation] = useState(2.5);

      const [baseSpending, setBaseSpending] = useState(40000);
      const [targetSuccessRate, setTargetSuccessRate] = useState(80);
      const [upperGuardrail, setUpperGuardrail] = useState(90);
      const [lowerGuardrail, setLowerGuardrail] = useState(70);

      const [numSimulations, setNumSimulations] = useState(5000);

      const [goals, setGoals] = useState([]);
      const [incomeSources, setIncomeSources] = useState([]);

      const [results, setResults] = useState(null);
      const [isCalculating, setIsCalculating] = useState(false);

      const addGoal = () => {
        setGoals([
          ...goals,
          {
            id: Date.now(),
            name: '',
            amount: 0,
            startYear: 0,
            frequency: 1,
            endYear: planLength,
            continueThrough: true,
            customInflation: null,
          },
        ]);
      };

      const updateGoal = (id, field, value) => {
        setGoals(goals.map((g) => (g.id === id ? { ...g, [field]: value } : g)));
      };

      const removeGoal = (id) => {
        setGoals(goals.filter((g) => g.id !== id));
      };

      const addIncomeSource = () => {
        setIncomeSources([
          ...incomeSources,
          {
            id: Date.now(),
            name: '',
            amount: 0,
            startYear: 0,
            endYear: planLength,
            continueThrough: true,
            customInflation: null,
          },
        ]);
      };

      const updateIncomeSource = (id, field, value) => {
        setIncomeSources(incomeSources.map((i) => (i.id === id ? { ...i, [field]: value } : i)));
      };

      const removeIncomeSource = (id) => {
        setIncomeSources(incomeSources.filter((i) => i.id !== id));
      };

      const calculate = useCallback(() => {
        setIsCalculating(true);

        setTimeout(() => {
          const params = {
            portfolioValue,
            planLength,
            expectedReturn: expectedReturn / 100,
            stdDev: stdDev / 100,
            baseSpending,
            baseInflation: baseInflation / 100,
            goals,
            incomeSources,
            currentYear,
            clientAge,
          };

          const mainResult = runSimulation(params, numSimulations);

          const upperPortfolio = findPortfolioForSuccessRate(params, upperGuardrail / 100, numSimulations);
          const upperSpending = findSpendingForSuccessRate(params, upperPortfolio, targetSuccessRate / 100, numSimulations);

          const lowerPortfolio = findPortfolioForSuccessRate(params, lowerGuardrail / 100, numSimulations);
          const lowerSpending = findSpendingForSuccessRate(params, lowerPortfolio, targetSuccessRate / 100, numSimulations);

          const medianProjection = generateMedianProjection(params);

          const percentilePathData = [];
          for (let year = 0; year <= planLength; year++) {
            percentilePathData.push({
              year,
              calendarYear: currentYear + year,
              p10: mainResult.percentilePaths.p10[year],
              p25: mainResult.percentilePaths.p25[year],
              p33: mainResult.percentilePaths.p33[year],
              p50: mainResult.percentilePaths.p50[year],
              p67: mainResult.percentilePaths.p67[year],
              p75: mainResult.percentilePaths.p75[year],
              p90: mainResult.percentilePaths.p90[year],
            });
          }

          setResults({
            currentSuccess: mainResult.successRate,
            upperGuardrailPortfolio: upperPortfolio,
            upperGuardrailSpending: upperSpending,
            lowerGuardrailPortfolio: lowerPortfolio,
            lowerGuardrailSpending: lowerSpending,
            percentileEnding: mainResult.percentileEnding,
            percentilePathData,
            yearlyPercentiles: mainResult.yearlyPercentiles,
            medianProjection,
          });

          setIsCalculating(false);
        }, 100);
      }, [portfolioValue, planLength, expectedReturn, stdDev, baseSpending, baseInflation, goals, incomeSources, currentYear, clientAge, numSimulations, targetSuccessRate, upperGuardrail, lowerGuardrail]);

      const exportPDF = () => {
        if (!results) return;

        generatePDF(
          {
            currentYear,
            clientAge,
            planLength,
            portfolioValue,
            expectedReturn: expectedReturn / 100,
            stdDev: stdDev / 100,
            baseInflation: baseInflation / 100,
            baseSpending,
            targetSuccessRate: targetSuccessRate / 100,
            upperGuardrail: upperGuardrail / 100,
            lowerGuardrail: lowerGuardrail / 100,
            goals,
            incomeSources,
            numSimulations,
          },
          results
        );
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-6">
          <style>{`
            @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&family=DM+Sans:wght@400;500;600&display=swap');
            
            .font-display { font-family: 'Crimson Pro', serif; }
            .font-body { font-family: 'DM Sans', sans-serif; }
            
            input[type="number"], input[type="text"] {
              background: rgba(255,255,255,0.05);
              border: 1px solid rgba(255,255,255,0.1);
              border-radius: 8px;
              padding: 10px 14px;
              color: white;
              width: 100%;
              transition: all 0.2s;
            }
            
            input[type="number"]:focus, input[type="text"]:focus {
              outline: none;
              border-color: #e8b059;
              box-shadow: 0 0 0 3px rgba(232, 176, 89, 0.2);
            }
            
            input[type="range"] {
              -webkit-appearance: none;
              width: 100%;
              height: 8px;
              border-radius: 4px;
              background: rgba(255,255,255,0.1);
            }
            
            input[type="range"]::-webkit-slider-thumb {
              -webkit-appearance: none;
              width: 20px;
              height: 20px;
              border-radius: 50%;
              background: #e8b059;
              cursor: pointer;
              box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            }
            
            .checkbox-custom {
              appearance: none;
              width: 18px;
              height: 18px;
              border: 2px solid rgba(255,255,255,0.3);
              border-radius: 4px;
              cursor: pointer;
              transition: all 0.2s;
            }
            
            .checkbox-custom:checked {
              background: #e8b059;
              border-color: #e8b059;
            }
            
            .card {
              background: rgba(255,255,255,0.03);
              border: 1px solid rgba(255,255,255,0.08);
              border-radius: 16px;
              backdrop-filter: blur(10px);
            }
            
            .card-accent {
              border-left: 4px solid #e8b059;
            }
            
            .btn-primary {
              background: linear-gradient(135deg, #e8b059 0%, #d4a04a 100%);
              color: #1a1a2e;
              font-weight: 600;
              padding: 14px 32px;
              border-radius: 10px;
              transition: all 0.3s;
              box-shadow: 0 4px 15px rgba(232, 176, 89, 0.3);
            }
            
            .btn-primary:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 20px rgba(232, 176, 89, 0.4);
            }
            
            .btn-primary:disabled {
              opacity: 0.5;
              cursor: not-allowed;
              transform: none;
            }
            
            .btn-secondary {
              background: rgba(255,255,255,0.1);
              color: white;
              font-weight: 500;
              padding: 14px 32px;
              border-radius: 10px;
              transition: all 0.3s;
              border: 1px solid rgba(255,255,255,0.2);
            }
            
            .btn-secondary:hover {
              background: rgba(255,255,255,0.15);
            }
            
            .result-card {
              background: linear-gradient(135deg, rgba(232, 176, 89, 0.15) 0%, rgba(232, 176, 89, 0.05) 100%);
              border: 1px solid rgba(232, 176, 89, 0.3);
            }
            
            .guardrail-upper {
              background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.05) 100%);
              border: 1px solid rgba(76, 175, 80, 0.3);
            }
            
            .guardrail-lower {
              background: linear-gradient(135deg, rgba(255, 152, 0, 0.15) 0%, rgba(255, 152, 0, 0.05) 100%);
              border: 1px solid rgba(255, 152, 0, 0.3);
            }
            
            .table-container {
              overflow-x: auto;
            }
            
            table {
              width: 100%;
              border-collapse: collapse;
            }
            
            th {
              background: rgba(232, 176, 89, 0.2);
              padding: 12px 10px;
              text-align: right;
              font-weight: 600;
              font-size: 12px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            
            th:first-child { text-align: left; border-radius: 8px 0 0 0; }
            th:last-child { border-radius: 0 8px 0 0; }
            
            td {
              padding: 10px;
              text-align: right;
              border-bottom: 1px solid rgba(255,255,255,0.05);
              font-size: 13px;
            }
            
            td:first-child { text-align: left; }
            
            tr:hover td {
              background: rgba(255,255,255,0.02);
            }
            
            .loading-spinner {
              width: 24px;
              height: 24px;
              border: 3px solid rgba(26, 26, 46, 0.3);
              border-top-color: #1a1a2e;
              border-radius: 50%;
              animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
          `}</style>

          <div className="max-w-7xl mx-auto">
            {/* Header */}
            <div className="text-center mb-10">
              <h1 className="font-display text-5xl font-semibold mb-3 bg-gradient-to-r from-amber-200 via-yellow-300 to-amber-200 bg-clip-text text-transparent">
                Financial Planning Calculator
              </h1>
              <p className="text-slate-400 text-lg font-body">
                Monte Carlo simulation with dynamic guardrail analysis
              </p>
            </div>

            {/* Input Sections */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
              {/* Basic Info */}
              <div className="card card-accent p-6">
                <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Basic Information</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Current Year</label>
                    <input type="number" value={currentYear} onChange={(e) => setCurrentYear(parseInt(e.target.value) || 2026)} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Client Age</label>
                    <input type="number" value={clientAge} onChange={(e) => setClientAge(parseInt(e.target.value) || 60)} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Plan Length (years)</label>
                    <input type="number" value={planLength} onChange={(e) => setPlanLength(parseInt(e.target.value) || 30)} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Current Portfolio Value</label>
                    <CurrencyInput value={portfolioValue} onChange={setPortfolioValue} />
                  </div>
                </div>
              </div>

              {/* Spending & Guardrails */}
              <div className="card card-accent p-6">
                <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Spending & Guardrails</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Base Annual Spending</label>
                    <CurrencyInput value={baseSpending} onChange={setBaseSpending} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Target Success Rate (%)</label>
                    <PercentageInput value={targetSuccessRate} onChange={setTargetSuccessRate} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Upper Guardrail (%)</label>
                    <PercentageInput value={upperGuardrail} onChange={setUpperGuardrail} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Lower Guardrail (%)</label>
                    <PercentageInput value={lowerGuardrail} onChange={setLowerGuardrail} />
                  </div>
                </div>
              </div>

              {/* Market Assumptions */}
              <div className="card card-accent p-6">
                <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Market Assumptions</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Expected Return (%)</label>
                    <PercentageInput value={expectedReturn} onChange={setExpectedReturn} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Standard Deviation (%)</label>
                    <PercentageInput value={stdDev} onChange={setStdDev} />
                  </div>
                  <div>
                    <label className="block text-sm text-slate-400 mb-2">Base Inflation Rate (%)</label>
                    <PercentageInput value={baseInflation} onChange={setBaseInflation} />
                  </div>
                </div>
              </div>
            </div>

            {/* Goals Section */}
            <div className="card card-accent p-6 mb-6">
              <div className="flex justify-between items-center mb-5">
                <h2 className="font-display text-xl font-semibold text-amber-200">Spending Goals</h2>
                <button onClick={addGoal} className="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 rounded-lg text-amber-200 text-sm font-medium transition-colors">
                  + Add Goal
                </button>
              </div>

              {goals.length === 0 ? (
                <p className="text-slate-500 text-center py-6">No goals added yet. Click "Add Goal" to create one.</p>
              ) : (
                <div className="space-y-4">
                  {goals.map((goal) => (
                    <div key={goal.id} className="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4 items-end">
                        <div className="col-span-2">
                          <label className="block text-xs text-slate-400 mb-1">Name</label>
                          <input type="text" value={goal.name} onChange={(e) => updateGoal(goal.id, 'name', e.target.value)} placeholder="e.g., New Car" />
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Amount ($)</label>
                          <CurrencyInput value={goal.amount} onChange={(val) => updateGoal(goal.id, 'amount', val)} />
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Start Year</label>
                          <input 
                            type="text" 
                            value={goal.startYear} 
                            onChange={(e) => {
                              const val = e.target.value;
                              if (val === '' || /^\d+$/.test(val)) {
                                updateGoal(goal.id, 'startYear', val === '' ? '' : parseInt(val, 10));
                              }
                            }}
                            onBlur={(e) => {
                              if (e.target.value === '' || isNaN(parseInt(e.target.value, 10))) {
                                updateGoal(goal.id, 'startYear', 0);
                              }
                            }}
                          />
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Frequency (1=once)</label>
                          <input 
                            type="text" 
                            value={goal.frequency} 
                            onChange={(e) => {
                              const val = e.target.value;
                              if (val === '' || /^\d+$/.test(val)) {
                                updateGoal(goal.id, 'frequency', val === '' ? '' : parseInt(val, 10));
                              }
                            }}
                            onBlur={(e) => {
                              if (e.target.value === '' || isNaN(parseInt(e.target.value, 10))) {
                                updateGoal(goal.id, 'frequency', 1);
                              }
                            }}
                          />
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">End Year</label>
                          <input 
                            type="text" 
                            value={goal.endYear} 
                            onChange={(e) => {
                              const val = e.target.value;
                              if (val === '' || /^\d+$/.test(val)) {
                                updateGoal(goal.id, 'endYear', val === '' ? '' : parseInt(val, 10));
                              }
                            }}
                            onBlur={(e) => {
                              if (e.target.value === '' || isNaN(parseInt(e.target.value, 10))) {
                                updateGoal(goal.id, 'endYear', planLength);
                              }
                            }}
                            disabled={goal.continueThrough} 
                          />
                        </div>
                        <div className="flex items-center gap-2">
                          <input type="checkbox" className="checkbox-custom" checked={goal.continueThrough} onChange={(e) => updateGoal(goal.id, 'continueThrough', e.target.checked)} />
                          <label className="text-xs text-slate-400">To end</label>
                        </div>
                        <div className="flex gap-2 items-end">
                          <div className="flex-1">
                            <label className="block text-xs text-slate-400 mb-1">Inflation (%)</label>
                            <PercentageInputNullable
                              value={goal.customInflation}
                              onChange={(val) => updateGoal(goal.id, 'customInflation', val)}
                              placeholder={baseInflation.toString()}
                            />
                          </div>
                          <button onClick={() => removeGoal(goal.id)} className="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg text-red-300 text-sm transition-colors">
                            âœ•
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Income Sources Section */}
            <div className="card card-accent p-6 mb-6">
              <div className="flex justify-between items-center mb-5">
                <h2 className="font-display text-xl font-semibold text-amber-200">Income Sources</h2>
                <button onClick={addIncomeSource} className="px-4 py-2 bg-amber-500/20 hover:bg-amber-500/30 rounded-lg text-amber-200 text-sm font-medium transition-colors">
                  + Add Income
                </button>
              </div>

              {incomeSources.length === 0 ? (
                <p className="text-slate-500 text-center py-6">No income sources added yet. Click "Add Income" to create one.</p>
              ) : (
                <div className="space-y-4">
                  {incomeSources.map((income) => (
                    <div key={income.id} className="bg-slate-800/50 rounded-xl p-4 border border-slate-700/50">
                      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 items-end">
                        <div className="col-span-2">
                          <label className="block text-xs text-slate-400 mb-1">Name</label>
                          <input type="text" value={income.name} onChange={(e) => updateIncomeSource(income.id, 'name', e.target.value)} placeholder="e.g., Social Security" />
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Annual Amount ($)</label>
                          <CurrencyInput value={income.amount} onChange={(val) => updateIncomeSource(income.id, 'amount', val)} />
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">Start Year</label>
                          <input 
                            type="text" 
                            value={income.startYear} 
                            onChange={(e) => {
                              const val = e.target.value;
                              if (val === '' || /^\d+$/.test(val)) {
                                updateIncomeSource(income.id, 'startYear', val === '' ? '' : parseInt(val, 10));
                              }
                            }}
                            onBlur={(e) => {
                              if (e.target.value === '' || isNaN(parseInt(e.target.value, 10))) {
                                updateIncomeSource(income.id, 'startYear', 0);
                              }
                            }}
                          />
                        </div>
                        <div>
                          <label className="block text-xs text-slate-400 mb-1">End Year</label>
                          <input 
                            type="text" 
                            value={income.endYear} 
                            onChange={(e) => {
                              const val = e.target.value;
                              if (val === '' || /^\d+$/.test(val)) {
                                updateIncomeSource(income.id, 'endYear', val === '' ? '' : parseInt(val, 10));
                              }
                            }}
                            onBlur={(e) => {
                              if (e.target.value === '' || isNaN(parseInt(e.target.value, 10))) {
                                updateIncomeSource(income.id, 'endYear', planLength);
                              }
                            }}
                            disabled={income.continueThrough} 
                          />
                        </div>
                        <div className="flex items-center gap-2">
                          <input type="checkbox" className="checkbox-custom" checked={income.continueThrough} onChange={(e) => updateIncomeSource(income.id, 'continueThrough', e.target.checked)} />
                          <label className="text-xs text-slate-400">To end</label>
                        </div>
                        <div className="flex gap-2 items-end">
                          <div className="flex-1">
                            <label className="block text-xs text-slate-400 mb-1">Inflation (%)</label>
                            <PercentageInputNullable
                              value={income.customInflation}
                              onChange={(val) => updateIncomeSource(income.id, 'customInflation', val)}
                              placeholder={baseInflation.toString()}
                            />
                          </div>
                          <button onClick={() => removeIncomeSource(income.id)} className="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg text-red-300 text-sm transition-colors">
                            âœ•
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Simulation Settings */}
            <div className="card card-accent p-6 mb-8">
              <h2 className="font-display text-xl font-semibold mb-5 text-amber-200">Simulation Settings</h2>
              <div className="flex items-center gap-6">
                <label className="text-sm text-slate-400 whitespace-nowrap">Number of Simulations:</label>
                <input type="range" min="1000" max="10000" step="500" value={numSimulations} onChange={(e) => setNumSimulations(parseInt(e.target.value))} className="flex-1" />
                <span className="text-amber-200 font-semibold min-w-[80px] text-right">{numSimulations.toLocaleString()}</span>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex justify-center gap-4 mb-10">
              <button onClick={calculate} disabled={isCalculating} className="btn-primary flex items-center gap-3">
                {isCalculating ? (
                  <>
                    <div className="loading-spinner"></div>
                    Calculating...
                  </>
                ) : (
                  <>
                    <span>ðŸŽ²</span>
                    Calculate
                  </>
                )}
              </button>
              {results && (
                <button onClick={exportPDF} className="btn-secondary flex items-center gap-3">
                  <span>ðŸ“„</span>
                  Export PDF
                </button>
              )}
            </div>

            {/* Results Section */}
            {results && (
              <div className="space-y-8">
                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="card result-card p-6">
                    <div className="text-sm text-amber-200/70 uppercase tracking-wide mb-2">Current Success Probability</div>
                    <div className="text-4xl font-display font-semibold text-amber-100">{(results.currentSuccess * 100).toFixed(1)}%</div>
                    <div className="text-sm text-slate-400 mt-2">Based on {numSimulations.toLocaleString()} simulations</div>
                  </div>

                  <div className="card guardrail-upper p-6">
                    <div className="text-sm text-green-300/70 uppercase tracking-wide mb-2">Upper Guardrail ({upperGuardrail}%)</div>
                    <div className="space-y-2">
                      <div className="flex justify-between">
                        <span className="text-slate-300">Portfolio Value:</span>
                        <span className="font-semibold text-green-200">{formatCurrency(results.upperGuardrailPortfolio)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-300">New Spending:</span>
                        <span className="font-semibold text-green-200">{formatCurrency(results.upperGuardrailSpending)}</span>
                      </div>
                      <div className="flex justify-between pt-2 border-t border-green-500/20">
                        <span className="text-slate-400 text-sm">Spending Change:</span>
                        <span className="font-semibold text-green-300">+{formatCurrency(results.upperGuardrailSpending - baseSpending)}</span>
                      </div>
                    </div>
                  </div>

                  <div className="card guardrail-lower p-6">
                    <div className="text-sm text-orange-300/70 uppercase tracking-wide mb-2">Lower Guardrail ({lowerGuardrail}%)</div>
                    <div className="space-y-2">
                      <div className="flex justify-between">
                        <span className="text-slate-300">Portfolio Value:</span>
                        <span className="font-semibold text-orange-200">{formatCurrency(results.lowerGuardrailPortfolio)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-300">New Spending:</span>
                        <span className="font-semibold text-orange-200">{formatCurrency(results.lowerGuardrailSpending)}</span>
                      </div>
                      <div className="flex justify-between pt-2 border-t border-orange-500/20">
                        <span className="text-slate-400 text-sm">Spending Change:</span>
                        <span className="font-semibold text-orange-300">{formatCurrency(results.lowerGuardrailSpending - baseSpending)}</span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Percentile Ending Values */}
                <div className="card card-accent p-6">
                  <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Ending Portfolio Percentiles</h3>
                  <div className="grid grid-cols-5 gap-4">
                    {[
                      { label: '10th', value: results.percentileEnding.p10, color: 'text-red-300' },
                      { label: '25th', value: results.percentileEnding.p25, color: 'text-orange-300' },
                      { label: '50th', value: results.percentileEnding.p50, color: 'text-amber-300' },
                      { label: '75th', value: results.percentileEnding.p75, color: 'text-green-300' },
                      { label: '90th', value: results.percentileEnding.p90, color: 'text-emerald-300' },
                    ].map((p) => (
                      <div key={p.label} className="text-center bg-slate-800/50 rounded-xl p-4">
                        <div className="text-sm text-slate-400 mb-1">{p.label} Percentile</div>
                        <div className={`text-xl font-semibold ${p.color}`}>{formatCurrency(p.value)}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Charts Row */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Percentile Paths Chart */}
                  <div className="card card-accent p-6">
                    <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Portfolio Paths by Percentile</h3>
                    <ResponsiveContainer width="100%" height={350}>
                      <LineChart data={results.percentilePathData}>
                        <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                        <XAxis dataKey="calendarYear" stroke="#94a3b8" fontSize={12} />
                        <YAxis stroke="#94a3b8" fontSize={12} tickFormatter={(v) => `$${(v / 1000000).toFixed(1)}M`} />
                        <Tooltip
                          contentStyle={{ background: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                          formatter={(value) => formatCurrency(value)}
                          labelFormatter={(label) => `Year ${label}`}
                        />
                        <Legend />
                        <Line type="monotone" dataKey="p10" name="10th" stroke="#ef4444" strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="p25" name="25th" stroke="#f97316" strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="p33" name="33rd" stroke="#eab308" strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="p50" name="50th (Median)" stroke="#22c55e" strokeWidth={3} dot={false} />
                        <Line type="monotone" dataKey="p67" name="67th" stroke="#14b8a6" strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="p75" name="75th" stroke="#3b82f6" strokeWidth={2} dot={false} />
                        <Line type="monotone" dataKey="p90" name="90th" stroke="#8b5cf6" strokeWidth={2} dot={false} />
                      </LineChart>
                    </ResponsiveContainer>
                  </div>

                  {/* Percentile Bands Chart */}
                  <div className="card card-accent p-6">
                    <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Portfolio Percentile Bands</h3>
                    <ResponsiveContainer width="100%" height={350}>
                      <AreaChart data={results.yearlyPercentiles}>
                        <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.1)" />
                        <XAxis dataKey="year" stroke="#94a3b8" fontSize={12} />
                        <YAxis stroke="#94a3b8" fontSize={12} tickFormatter={(v) => `$${(v / 1000000).toFixed(1)}M`} />
                        <Tooltip
                          contentStyle={{ background: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                          formatter={(value) => formatCurrency(value)}
                          labelFormatter={(label) => `Year ${label}`}
                        />
                        <Area type="monotone" dataKey="p90" stackId="1" stroke="none" fill="rgba(139, 92, 246, 0.3)" name="90th" />
                        <Area type="monotone" dataKey="p75" stackId="2" stroke="none" fill="rgba(59, 130, 246, 0.3)" name="75th" />
                        <Area type="monotone" dataKey="p50" stackId="3" stroke="#22c55e" strokeWidth={2} fill="rgba(34, 197, 94, 0.3)" name="50th" />
                        <Area type="monotone" dataKey="p25" stackId="4" stroke="none" fill="rgba(249, 115, 22, 0.3)" name="25th" />
                        <Area type="monotone" dataKey="p10" stackId="5" stroke="none" fill="rgba(239, 68, 68, 0.3)" name="10th" />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div>
                </div>

                {/* Year-by-Year Table */}
                <div className="card card-accent p-6">
                  <h3 className="font-display text-xl font-semibold mb-5 text-amber-200">Year-by-Year Projection (Median Returns, Mid-Year Withdrawal)</h3>
                  <div className="table-container max-h-[500px] overflow-y-auto">
                    <table>
                      <thead className="sticky top-0">
                        <tr>
                          <th>Year</th>
                          <th>Age</th>
                          <th>Start Balance</th>
                          <th>Base Spending</th>
                          <th>Goals</th>
                          <th>Income</th>
                          <th>Net Withdrawal</th>
                          <th>Portfolio (Mid-Year)</th>
                          <th>Return %</th>
                          <th>Return $</th>
                          <th>End Balance</th>
                        </tr>
                      </thead>
                      <tbody>
                        {results.medianProjection.map((row) => (
                          <tr key={row.year}>
                            <td className="font-medium">{row.calendarYear}</td>
                            <td>{row.age}</td>
                            <td>{formatCurrency(row.startBalance)}</td>
                            <td>{formatCurrency(row.baseSpending)}</td>
                            <td>{formatCurrency(row.goals)}</td>
                            <td className="text-green-400">{formatCurrency(row.income)}</td>
                            <td className={row.netWithdrawal > 0 ? 'text-orange-400' : 'text-green-400'}>{formatCurrency(row.netWithdrawal)}</td>
                            <td>{formatCurrency(row.portfolioAfterWithdrawal)}</td>
                            <td className="text-blue-400">{(row.returnRate * 100).toFixed(1)}%</td>
                            <td className="text-blue-400">{formatCurrency(row.returnAmount)}</td>
                            <td className="font-medium">{formatCurrency(row.endBalance)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<FinancialPlanningCalculator />, document.getElementById('root'));
  </script>
</body>
</html>
